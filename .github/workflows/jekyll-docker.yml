name: Build, Test, and Deploy Tree Selling App with Docker

on:
  push:
    branches:
      - main  # Trigger on push to the main branch
  pull_request:
    branches:
      - main  # Trigger on pull request targeting the main branch

jobs:
  build:
    runs-on: ubuntu-latest  # Use the latest Ubuntu image

    steps:
    # Step 1: Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Set up Docker Buildx (for multi-platform builds)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    # Step 3: Build the Docker image
    - name: Build Docker image
      run: |
        docker build -t tree-selling-app .

  test:
    runs-on: ubuntu-latest  # Use the latest Ubuntu image

    steps:
    # Step 1: Checkout repository (to access the code and Dockerfile)
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    # Step 3: Build the Docker image (again in test step to ensure consistency)
    - name: Build Docker image for testing
      run: |
        docker build -t tree-selling-app .

    # Step 4: Log in to Docker Hub using GitHub Secrets for Docker credentials
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}  # Docker Hub username from GitHub Secrets
        password: ${{ secrets.DOCKER_TOKEN }}  # Docker Hub token from GitHub Secrets

    # Step 5: Run Docker container to check if app is working
    - name: Run Docker container
      run: |
        docker run -d -p 8080:80 tree-selling-app

    # Step 6: Wait for the app to start
    - name: Wait for the app to start
      run: sleep 15  # Allow time for the app to load

    # Step 7: Run a test to confirm the app is working (using curl)
    - name: Check if app is accessible
      run: |
        curl --fail http://localhost:8080 || exit 1  # Ensure the app is reachable

    # Step 8: Clean up (stop the container after testing)
    - name: Stop Docker container after testing
      run: |
        docker ps -q -f "ancestor=tree-selling-app" | xargs docker stop
        docker ps -q -f "ancestor=tree-selling-app" | xargs docker rm

  deploy:
    runs-on: ubuntu-latest  # Use the latest Ubuntu image
    needs: [build, test]  # Ensure this step runs only after the build and test jobs complete successfully
    environment: production  # Define the environment for deployment

    steps:
    # Step 1: Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Deploy Docker container to your server (e.g., AWS, DigitalOcean, etc.)
    # Here you would deploy your Docker image to a production environment.
    # This example uses SSH to deploy to a remote server. You should replace it with your deployment setup.

    # Example: Deploy to a remote server via SSH
    - name: Deploy to Production Server via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          docker pull tree-selling-app
          docker stop tree-selling-app || true  # Stop any existing container
          docker rm tree-selling-app || true    # Remove the stopped container
          docker run -d -p 8080:80 --name tree-selling-app tree-selling-app
          
    # Optionally, deploy to a hosting platform like AWS, Azure, etc.
    # Example: AWS EC2 or ECS deployment using the `aws-actions` GitHub Actions.
