name: Build and Deploy Tree Selling App with Docker

on:
  push:
    branches:
      - main  # Trigger this workflow on push to the main branch
  pull_request:
    branches:
      - main  # Trigger this workflow on pull request targeting the main branch

jobs:
  build:
    runs-on: ubuntu-latest  # Use the latest Ubuntu image

    steps:
    # Step 1: Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    # Step 3: Build Docker image
    - name: Build Docker image
      run: |
        docker build -t tree-selling-app .

    # Step 4: Run Docker container
    - name: Run Docker container
      run: |
        docker run -d -p 8080:80 tree-selling-app

    # Step 5: Wait for a while to let the app start
    - name: Wait for the app to start
      run: sleep 15  # Wait for 15 seconds to ensure the app is up

    # Step 6: Run a test to confirm the app is working
    - name: Check if app is accessible
      run: |
        curl --fail http://localhost:8080 || exit 1  # Check if app is running

    # Optional: Step 7 - Clean up (stop the Docker container after test)
    - name: Stop Docker container
      run: |
        docker ps -q -f "ancestor=tree-selling-app" | xargs docker stop
